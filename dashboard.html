<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Health AI - Professional Medical Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
    <!-- Firebase (compat CDN) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
</head>

<body style="background-color: #f4f7f6;" class="min-h-screen">
    <!-- Professional Hospital Header (Fixed) -->
    <nav class="hospital-header fixed top-0 left-0 right-0 bg-white shadow-md z-50 border-b-2 border-blue-500">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <!-- Left: Logo & Home -->
                <div class="flex items-center gap-6">
                    <a href="dashboard.html"
                        class="flex items-center gap-2 text-2xl font-bold text-gray-800 hover:text-blue-600 transition">
                        <span class="text-3xl">üè•</span>
                        <span>Smart Health <span class="text-blue-600">AI</span></span>
                    </a>
                    <a href="dashboard.html"
                        class="text-gray-600 hover:text-blue-600 transition flex items-center gap-1"
                        onclick="showSection('dashboard'); return false;">
                        <span class="text-xl">üè†</span>
                        <span class="font-medium">Home</span>
                    </a>
                </div>

                <!-- Right: Navigation Links -->
                <div class="flex items-center gap-6">
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-600 transition font-medium"
                        onclick="showSection('reports'); return false;">
                        üìã Medical Records
                    </a>
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-600 transition font-medium"
                        onclick="showSection('vitals'); return false;">
                        ü©∏ Vitals Tracker
                    </a>
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-600 transition font-medium"
                        onclick="showSection('lifestyle'); return false;">
                        üçè Diet & Exercise
                    </a>
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-600 transition font-medium"
                        onclick="showSection('appointments'); return false;">
                        üìÖ Appointments
                    </a>
                    <button id="logout-btn"
                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium shadow-sm">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area (with top padding for fixed header) -->
    <main class="container mx-auto px-6 py-8 max-w-7xl" style="margin-top: 80px;">

        <!-- SECTION 1: Dashboard (Command Center) -->
        <div id="dashboard-section" class="content-section">
            <!-- Patient Profile Banner -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8 fade-in border border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                            <span id="user-initials">U</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Patient Profile</h2>
                            <p class="text-gray-600" id="patient-name">Loading...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span
                            class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-green-100 text-green-700 border border-green-200">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                            Health Status: Stable
                        </span>
                    </div>
                </div>
            </div>

            <!-- Command Center Grid -->
            <div class="mb-8">
                <h3 class="text-3xl font-bold text-gray-800 mb-6">Command Center</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

                    <!-- Card 1: Medical Intelligence -->
                    <div class="command-card bg-white rounded-xl p-6 shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 cursor-pointer"
                        onclick="showSection('reports')">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-20 h-20 rounded-2xl flex items-center justify-center mb-4 text-5xl"
                                style="background-color: #2c3e50;">
                                <span class="text-white">üìã</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Medical Intelligence</h3>
                            <p class="text-sm text-gray-600">Analyze reports with AI</p>
                        </div>
                    </div>

                    <!-- Card 2: Health Vitals -->
                    <div class="command-card bg-white rounded-xl p-6 shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 cursor-pointer"
                        onclick="showSection('vitals')">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-20 h-20 rounded-2xl flex items-center justify-center mb-4 text-5xl"
                                style="background-color: #e74c3c;">
                                <span class="text-white">ü©∏</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Health Vitals</h3>
                            <p class="text-sm text-gray-600">Track BP, Sugar, and BMI</p>
                        </div>
                    </div>

                    <!-- Card 3: Lifestyle Coach -->
                    <div class="command-card bg-white rounded-xl p-6 shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 cursor-pointer"
                        onclick="showSection('lifestyle')">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-20 h-20 rounded-2xl flex items-center justify-center mb-4 text-5xl"
                                style="background-color: #16a085;">
                                <span class="text-white">üçè</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Lifestyle Coach</h3>
                            <p class="text-sm text-gray-600">Custom Diet & Workout plans</p>
                        </div>
                    </div>

                    <!-- Card 4: Care Scheduler -->
                    <div class="command-card bg-white rounded-xl p-6 shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 cursor-pointer"
                        onclick="showSection('appointments')">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-20 h-20 rounded-2xl flex items-center justify-center mb-4 text-5xl"
                                style="background-color: #3498db;">
                                <span class="text-white">üìÖ</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Care Scheduler</h3>
                            <p class="text-sm text-gray-600">Book and track appointments</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vitals Summary -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Your Vitals at a Glance</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <p class="text-xs text-gray-600 uppercase font-semibold mb-1">BMI</p>
                        <p class="text-2xl font-bold text-gray-800" id="bmi-value">-</p>
                        <p class="text-xs text-gray-500 mt-1" id="bmi-status">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-red-500">
                        <p class="text-xs text-gray-600 uppercase font-semibold mb-1">Blood Pressure</p>
                        <p class="text-2xl font-bold text-gray-800" id="bp-value">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-yellow-500">
                        <p class="text-xs text-gray-600 uppercase font-semibold mb-1">Blood Sugar</p>
                        <p class="text-2xl font-bold text-gray-800" id="sugar-value">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-green-500">
                        <p class="text-xs text-gray-600 uppercase font-semibold mb-1">Activity Level</p>
                        <p class="text-2xl font-bold text-gray-800" id="activity-value">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: Medical Reports -->
        <div id="reports-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üìã Medical Intelligence Center</h2>

                <!-- Upload Section -->
                <div class="mb-8 p-6 bg-blue-50 rounded-lg border-2 border-blue-200">
                    <h3 class="text-xl font-semibold mb-4 text-blue-900">Upload Medical Report</h3>
                    <form id="uploadForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="report-name" required placeholder="Report Name (e.g., Blood Test)"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <select id="report-type" required
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Type</option>
                                <option value="Blood Test">Blood Test</option>
                                <option value="X-Ray">X-Ray</option>
                                <option value="MRI">MRI</option>
                                <option value="CT Scan">CT Scan</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="date" id="report-date" required
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <input type="file" id="report-file" required accept=".pdf,.jpg,.jpeg,.png"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div id="upload-progress" class="hidden">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="progress-bar"
                                    class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
                                    style="width: 0%"></div>
                            </div>
                            <p id="progress-text" class="text-sm text-gray-600 mt-1">Uploading...</p>
                        </div>
                        <div id="upload-error" class="text-red-600 text-sm hidden"></div>
                        <div id="upload-success" class="text-green-600 text-sm hidden"></div>
                        <button type="submit"
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-lg">
                            üì§ Upload Report
                        </button>
                    </form>
                </div>

                <!-- Reports List -->
                <div>
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Your Medical Reports</h3>
                    <div id="reports-list" class="space-y-4">
                        <p class="text-gray-600 text-center py-8">Loading reports...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 3: Vitals Tracker -->
        <div id="vitals-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">ü©∏ Health Vitals Tracker</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- BP Tracker -->
                    <div class="p-6 bg-red-50 rounded-lg border-2 border-red-200">
                        <h3 class="text-lg font-semibold mb-4 text-red-900">Add Blood Pressure Reading</h3>
                        <form id="bp-form" class="space-y-3">
                            <div class="flex gap-2">
                                <input type="number" id="systolic" placeholder="Systolic" required
                                    class="flex-1 px-3 py-2 border rounded-lg">
                                <input type="number" id="diastolic" placeholder="Diastolic" required
                                    class="flex-1 px-3 py-2 border rounded-lg">
                            </div>
                            <button type="submit"
                                class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Add
                                BP</button>
                        </form>
                    </div>

                    <!-- Sugar Tracker -->
                    <div class="p-6 bg-yellow-50 rounded-lg border-2 border-yellow-200">
                        <h3 class="text-lg font-semibold mb-4 text-yellow-900">Add Blood Sugar Reading</h3>
                        <form id="sugar-form" class="space-y-3">
                            <input type="number" id="blood-sugar" placeholder="mg/dL" required
                                class="w-full px-3 py-2 border rounded-lg">
                            <select id="sugar-type" class="w-full px-3 py-2 border rounded-lg">
                                <option value="fasting">Fasting</option>
                                <option value="post-meal">Post-meal</option>
                            </select>
                            <button type="submit"
                                class="w-full bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition">Add
                                Sugar</button>
                        </form>
                    </div>
                </div>

                <!-- Recent Readings -->
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Recent Readings</h3>
                    <div id="health-readings" class="space-y-2">
                        <p class="text-gray-600 text-center py-4">No readings yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 4: Lifestyle Coach -->
        <div id="lifestyle-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üçè Lifestyle Coach</h2>
                <p class="text-gray-600 mb-6">Generate personalized diet and exercise plans based on your health
                    profile.</p>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <button onclick="handleGenerateDietPlan('weight-loss-veg')"
                        class="p-4 bg-green-100 rounded-lg hover:bg-green-200 transition border-2 border-green-300">
                        <div class="text-3xl mb-2">ü•ó</div>
                        <div class="font-semibold">Weight Loss (Veg)</div>
                    </button>
                    <button onclick="handleGenerateDietPlan('weight-loss-nonveg')"
                        class="p-4 bg-orange-100 rounded-lg hover:bg-orange-200 transition border-2 border-orange-300">
                        <div class="text-3xl mb-2">üçó</div>
                        <div class="font-semibold">Weight Loss (Non-Veg)</div>
                    </button>
                    <button onclick="handleGenerateDietPlan('weight-gain')"
                        class="p-4 bg-blue-100 rounded-lg hover:bg-blue-200 transition border-2 border-blue-300">
                        <div class="text-3xl mb-2">üí™</div>
                        <div class="font-semibold">Weight Gain</div>
                    </button>
                    <button onclick="handleGenerateDietPlan('bp-patient')"
                        class="p-4 bg-red-100 rounded-lg hover:bg-red-200 transition border-2 border-red-300">
                        <div class="text-3xl mb-2">‚ù§Ô∏è</div>
                        <div class="font-semibold">BP Management</div>
                    </button>
                    <button onclick="handleGenerateDietPlan('sugar-patient')"
                        class="p-4 bg-yellow-100 rounded-lg hover:bg-yellow-200 transition border-2 border-yellow-300">
                        <div class="text-3xl mb-2">üç¨</div>
                        <div class="font-semibold">Diabetes Care</div>
                    </button>
                    <button onclick="showCustomDietModal()"
                        class="p-4 bg-purple-100 rounded-lg hover:bg-purple-200 transition border-2 border-purple-300">
                        <div class="text-3xl mb-2">‚öïÔ∏è</div>
                        <div class="font-semibold">Custom Plan</div>
                    </button>
                </div>

                <!-- Diet Plan Display -->
                <div id="diet-plan-display" class="hidden mt-8 p-6 bg-gray-50 rounded-lg border-2 border-gray-300">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Your Personalized Plan</h3>
                        <div class="flex gap-2">
                            <button onclick="exportDietPDF()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">üìÑ
                                Print</button>
                            <button onclick="exportDietText()"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">üíæ
                                Download</button>
                            <button onclick="closeDietPlan()"
                                class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-sm">‚úï
                                Close</button>
                        </div>
                    </div>
                    <div id="diet-plan-content"
                        class="whitespace-pre-wrap text-gray-700 max-h-96 overflow-y-auto p-4 bg-white rounded border">
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 5: Appointments -->
        <div id="appointments-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üìÖ Care Scheduler</h2>

                <div class="mb-6">
                    <button onclick="showAppointmentRequestForm()"
                        class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold shadow-lg">
                        ‚ûï Request New Appointment
                    </button>
                </div>

                <!-- Appointment Request Form -->
                <div id="appointment-request-form"
                    class="hidden mb-6 p-6 bg-purple-50 rounded-lg border-2 border-purple-200">
                    <form id="request-appointment-form" class="space-y-4">
                        <select id="doctor-select" required class="w-full px-4 py-2 border rounded-lg">
                            <option value="">Choose a doctor...</option>
                        </select>
                        <input type="datetime-local" id="appointment-datetime" required
                            class="w-full px-4 py-2 border rounded-lg">
                        <textarea id="appointment-reason" rows="3" required class="w-full px-4 py-2 border rounded-lg"
                            placeholder="Describe your symptoms or reason..."></textarea>
                        <div class="flex gap-2">
                            <button id="request-appointment-submit" type="submit" disabled
                                class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition opacity-50 cursor-not-allowed">Send
                                Request</button>
                            <button type="button" onclick="hideAppointmentRequestForm()"
                                class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- Appointments List -->
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">My Appointments</h3>
                    <div id="my-appointments-list" class="space-y-3">
                        <p class="text-gray-600 text-center py-4">No appointments found</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Custom Diet Modal -->
    <div id="custom-diet-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-semibold mb-4">Custom Diet Plan</h3>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Disease or Health Issue</label>
                <input type="text" id="custom-disease" placeholder="e.g., PCOS, Thyroid, etc."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex gap-4">
                <button onclick="generateCustomDiet()"
                    class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Generate</button>
                <button onclick="closeCustomDietModal()"
                    class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/secure-config.js"></script>
    <script src="js/config.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/auth-guard.js"></script>

        <script>
            // Enable appointment UI once auth is resolved (not waiting for reports.js)
            (function() {
                function enableAppointmentUI() {
                    const btn = document.getElementById('request-appointment-submit');
                    if (btn) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }

                // If authGuard exists, use its requireAuth; otherwise enable immediately.
                if (window.authGuard && typeof window.authGuard.requireAuth === 'function') {
                    window.authGuard.requireAuth(() => {
                        try { enableAppointmentUI(); } catch (e) { console.warn('Enable appointment UI error', e); }
                    });
                } else {
                    // Fallback: if firebase is ready and user logged in, enable
                    if (window.firebase && firebase.auth && firebase.auth().currentUser) {
                        enableAppointmentUI();
                    } else {
                        // As last resort, enable after short delay to avoid blocking UI indefinitely
                        setTimeout(enableAppointmentUI, 2000);
                    }
                }
            })();
        </script>

    <script>
        // Section Navigation Logic
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('fade-in');
            }

            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('text-blue-600', 'font-bold');
                link.classList.add('text-gray-700');
            });
        }

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async () => {
            sessionStorage.clear();
            await logoutUser();
            window.location.href = 'login.html';
        });

        // Patient Profile Update
        async function updatePatientProfile() {
            try {
                const user = getCurrentUser();
                if (user) {
                    const profileResult = await getHealthProfile();
                    if (profileResult.success) {
                        const profile = profileResult.data;
                        const userName = profile.username || user.email.split('@')[0];
                        const userAge = profile.age || 'N/A';
                        document.getElementById('patient-name').textContent = `${userName}, ${userAge}`;
                        const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                        document.getElementById('user-initials').textContent = initials;
                    }
                }
            } catch (error) {
                console.error('Error updating patient profile:', error);
            }
        }

        // Diet Plan Handlers
        let currentDietPlan = '';

        async function handleGenerateDietPlan(dietType) {
            const displayArea = document.getElementById('diet-plan-display');
            const contentArea = document.getElementById('diet-plan-content');
            displayArea.classList.remove('hidden');
            contentArea.innerHTML = '<div class="spinner mx-auto"></div><p class="text-center mt-4">Generating your personalized diet plan...</p>';

            const result = await generateDietPlan(dietType);
            if (result.success) {
                currentDietPlan = result.plan;
                const planText = typeof result.plan === 'string' ? result.plan : JSON.stringify(result.plan, null, 2);
                contentArea.textContent = planText;
            } else {
                contentArea.innerHTML = `<p class="text-red-600">Error: ${result.error}</p>`;
            }
        }

        function showCustomDietModal() { document.getElementById('custom-diet-modal').classList.remove('hidden'); }
        function closeCustomDietModal() { document.getElementById('custom-diet-modal').classList.add('hidden'); }

        async function generateCustomDiet() {
            const disease = document.getElementById('custom-disease').value;
            if (!disease.trim()) { alert('Please enter a disease or health issue'); return; }
            closeCustomDietModal();
            await handleGenerateDietPlan('custom');
        }

        function closeDietPlan() { document.getElementById('diet-plan-display').classList.add('hidden'); }
        function exportDietPDF() { if (currentDietPlan) exportDietPlanToPDF(currentDietPlan); }
        function exportDietText() { if (currentDietPlan) exportDietPlanToText(currentDietPlan); }

        // Health Tracking Forms
        document.getElementById('bp-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const systolic = parseInt(document.getElementById('systolic').value);
            const diastolic = parseInt(document.getElementById('diastolic').value);
            await addHealthReading('bp', { systolic, diastolic });
            document.getElementById('bp-form').reset();
            loadHealthReadings();
        });

        document.getElementById('sugar-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const value = parseInt(document.getElementById('blood-sugar').value);
            const sugarType = document.getElementById('sugar-type').value;
            await addHealthReading('sugar', { value, sugarType });
            document.getElementById('sugar-form').reset();
            loadHealthReadings();
        });

        async function addHealthReading(type, data) {
            try {
                const { db, auth } = _getFirebaseInstances();
                const user = auth.currentUser;
                if (!user) return;
                await db.collection('users').doc(user.uid).collection('health-readings').add({
                    type, ...data,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error adding health reading:', error);
            }
        }

        async function loadHealthReadings() {
            try {
                const { db, auth } = _getFirebaseInstances();
                const user = auth.currentUser;
                if (!user) return;
                const readingsSnap = await db.collection('users').doc(user.uid).collection('health-readings')
                    .orderBy('timestamp', 'desc').limit(10).get();
                const container = document.getElementById('health-readings');
                container.innerHTML = '';
                readingsSnap.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-gray-50 rounded border';
                    if (data.type === 'bp') {
                        div.textContent = `BP: ${data.systolic}/${data.diastolic} (${new Date(data.timestamp.toDate()).toLocaleString()})`;
                    } else if (data.type === 'sugar') {
                        div.textContent = `Sugar: ${data.value} mg/dL (${data.sugarType}) (${new Date(data.timestamp.toDate()).toLocaleString()})`;
                    }
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading health readings:', error);
            }
        }

        // Appointment Functions
        function showAppointmentRequestForm() {
            document.getElementById('appointment-request-form').classList.remove('hidden');
            loadAvailableDoctors();
        }

        function hideAppointmentRequestForm() {
            document.getElementById('appointment-request-form').classList.add('hidden');
        }

        async function loadAvailableDoctors() {
            try {
                const { db } = _getFirebaseInstances();
                const doctorsSelect = document.getElementById('doctor-select');
                doctorsSelect.innerHTML = '<option value="">Choose a doctor...</option>';
                const doctorsSnapshot = await db.collection('users').where('role', '==', 'doctor').get();
                doctorsSnapshot.forEach(doc => {
                    const doctor = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `Dr. ${doctor.username || doctor.email}`;
                    doctorsSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading doctors:', error);
            }
        }

        document.getElementById('request-appointment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const doctorId = document.getElementById('doctor-select').value;
            const dateTime = document.getElementById('appointment-datetime').value;
            const reason = document.getElementById('appointment-reason').value.trim();
            if (!doctorId || !dateTime || !reason) {
                alert('Please fill in all fields');
                return;
            }
            const result = await requestAppointment(doctorId, dateTime, reason);
            if (result.success) {
                alert('Appointment request sent successfully!');
                hideAppointmentRequestForm();
                // Call loadMyAppointments if available; poll briefly if not yet defined
                if (typeof window.loadMyAppointments === 'function') {
                    try { window.loadMyAppointments(); } catch (e) { console.warn('loadMyAppointments error', e); }
                } else {
                    let waited = 0;
                    const iv = setInterval(() => {
                        if (typeof window.loadMyAppointments === 'function') {
                            clearInterval(iv);
                            try { window.loadMyAppointments(); } catch (e) { console.warn('loadMyAppointments error', e); }
                        }
                        waited += 200;
                        if (waited > 3000) clearInterval(iv);
                    }, 200);
                }
            } else {
                alert('Error requesting appointment: ' + result.error);
            }
        });

        // Upload Form Handler
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('report-file');
            const nameInput = document.getElementById('report-name');
            const typeInput = document.getElementById('report-type');
            const dateInput = document.getElementById('report-date');

            const file = fileInput.files[0];
            const name = nameInput.value.trim();
            const type = typeInput.value;
            const date = dateInput.value;

            document.getElementById('upload-error').classList.add('hidden');
            document.getElementById('upload-success').classList.add('hidden');
            document.getElementById('upload-progress').classList.add('hidden');

            if (!file || !name || !type || !date) {
                document.getElementById('upload-error').textContent = 'Please fill in all fields';
                document.getElementById('upload-error').classList.remove('hidden');
                return;
            }

            document.getElementById('upload-progress').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-text').textContent = 'Starting upload...';

            try {
                const result = await uploadMedicalReport(file, name, type, date, null, (progress) => {
                    document.getElementById('progress-bar').style.width = progress + '%';
                    document.getElementById('progress-text').textContent = `Uploading... ${Math.round(progress)}%`;
                });

                if (result.success) {
                    document.getElementById('upload-success').textContent = 'Medical report uploaded successfully!';
                    document.getElementById('upload-success').classList.remove('hidden');
                    document.getElementById('uploadForm').reset();
                    if (typeof loadReportsPage === 'function') loadReportsPage();
                } else {
                    document.getElementById('upload-error').textContent = result.error || 'Upload failed';
                    document.getElementById('upload-error').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('upload-error').textContent = 'Upload failed: ' + error.message;
                document.getElementById('upload-error').classList.remove('hidden');
            } finally {
                document.getElementById('upload-progress').classList.add('hidden');
            }
        });

        // Initialize
        if (window.authGuard) {
            window.authGuard.requireAuth(async () => {
                await updatePatientProfile();
                if (typeof loadDashboard === 'function') loadDashboard();
                if (typeof loadReportsPage === 'function') loadReportsPage();
                if (typeof loadHealthReadings === 'function') loadHealthReadings();
                // Prefer using loadMyAppointments if available; otherwise use fetchAndRenderAppointments
                if (typeof loadMyAppointments === 'function') {
                    try { loadMyAppointments(); } catch (e) { console.warn('loadMyAppointments error', e); }
                } else if (typeof window.fetchAndRenderAppointments === 'function') {
                    try { window.fetchAndRenderAppointments(); } catch (e) { console.warn('fetchAndRenderAppointments error', e); }
                } else {
                    // Fallback: attempt to call fetchAndRenderAppointments shortly after
                    setTimeout(() => { if (typeof window.fetchAndRenderAppointments === 'function') window.fetchAndRenderAppointments(); }, 200);
                }
                showSection('dashboard'); // Start on dashboard
            });
        }

        // Inline helper: fetch appointments directly and render into #my-appointments-list
        // This runs independently of `reports.js` to ensure UI shows appointments immediately.
        window.fetchAndRenderAppointments = async function() {
            try {
                if (!window.firebase || !firebase.auth) return;
                const auth = firebase.auth();
                const db = firebase.firestore();
                const user = auth.currentUser;
                const container = document.getElementById('my-appointments-list');
                if (!user || !container) return;

                const snap = await db.collection('appointments')
                    .where('patientId', '==', user.uid)
                    .orderBy('createdAt', 'desc')
                    .get();

                if (snap.empty) {
                    container.innerHTML = '<p class="text-gray-600 text-center py-4">No appointments found</p>';
                    return;
                }

                const appts = [];
                snap.forEach(d => appts.push({ id: d.id, ...d.data() }));

                container.innerHTML = appts.map(appointment => {
                    const statusColor = {
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'accepted': 'bg-green-100 text-green-800',
                        'rejected': 'bg-red-100 text-red-800'
                    }[appointment.status] || 'bg-gray-100 text-gray-800';

                    const statusLabel = {
                        'pending': 'Doctor is reviewing',
                        'accepted': 'Approved by doctor',
                        'rejected': 'Rejected'
                    }[appointment.status] || (appointment.status ? appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1) : 'Unknown');

                    const consentButton = appointment.status === 'accepted' && !appointment.consentGranted ? `
                        <button onclick="grantConsent('${appointment.id}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">Grant Consent</button>
                    ` : appointment.consentGranted ? `
                        <button onclick="revokeConsent('${appointment.id}')" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 text-sm">Revoke Consent</button>
                    ` : '';

                    return `
                        <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-blue-500">
                          <div class="flex justify-between items-start">
                            <div class="flex-1">
                              <h3 class="text-lg font-semibold text-gray-800">${appointment.doctorName || 'Doctor'}</h3>
                              <p class="text-gray-600">${appointment.date || ''} at ${appointment.time || ''}</p>
                              <p class="text-sm text-gray-500">Reason: ${appointment.reason || ''}</p>
                              <span class="inline-block px-2 py-1 text-xs rounded-full ${statusColor} mt-2">${statusLabel}</span>
                              ${appointment.consentGranted ? '<span class="inline-block px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 ml-2">Consent Granted</span>' : ''}
                            </div>
                            <div class="flex gap-2 ml-4">${consentButton}</div>
                          </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('fetchAndRenderAppointments error:', err);
            }
        };
    </script>
</body>

</html>